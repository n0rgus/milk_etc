{% extends "base.html" %}
{% block content %}
<div class="d-flex flex-wrap gap-2 align-items-center mb-3">
  <form id="scrape-form" class="d-flex gap-2 align-items-center">
    <select class="form-select" style="max-width: 220px" name="store" id="scrape-store">
      <option value="ALL">Scrape ALL stores</option>
      {% for s in stores %}
      <option value="{{ s.name }}">{{ s.name }}</option>
      {% endfor %}
    </select>
    <button class="btn btn-primary" type="submit" id="scrape-submit-btn">Scrape now</button>
  </form>
  <span id="scrape-status" class="small muted"></span>

  <div class="ms-auto text-end">
    <div class="small muted">
      Scrape mode:
      {% if scrape_settings and scrape_settings.headful %}
        headful (slowmo {{ scrape_settings.slowmo_ms }}ms)
      {% else %}
        headless
      {% endif %}
    </div>
    <form method="post" action="/shop/start" class="mt-1">
      <button class="btn btn-success" type="submit">Start shop session</button>
    </form>
  </div>
</div>

{% if coles_blocked_count and coles_blocked_count > 0 %}
<div class="alert alert-warning" role="alert">
  Coles scrape is currently blocked by Imperva security checks on some items.
  Open <strong>Settings → Init Coles Session</strong>, complete the human verification, then scrape again.
</div>
{% endif %}

<div class="card shadow-sm">
  <div class="card-header bg-white">
    <div class="d-flex justify-content-between align-items-center">
      <div>
        <div class="fw-semibold">Today's price snapshot</div>
        <div class="muted small">Rows are your regular items. Add store URLs to enable scraping.</div>
      </div>
      <div class="small muted">Tip: Click an item to add/edit store URLs.</div>
    </div>
  </div>
  <div class="table-responsive">
    <table class="table table-sm table-striped align-middle mb-0">
      <thead class="table-light">
        <tr>
          <th>Item</th>
          <th>Category</th>
          <th>ALDI</th>
          <th>COLES</th>
          <th>WOOLWORTHS</th>
          <th>Best</th>
          <th>Cycle note</th>
        </tr>
      </thead>
      <tbody>
        {% for item in items %}
        <tr>
          <td>
            <a href="/items/{{ item.id }}" class="text-decoration-none">{{ item.name }}</a>
            {% if item.brand %}<span class="badge bg-secondary pill ms-1">{{ item.brand }}</span>{% endif %}
          </td>
          <td class="muted">{{ item.category or "" }}</td>

          {% for store_name in ["ALDI","COLES","WOOLWORTHS"] %}
            {% set ph = (latest.get(item.id) or {}).get(store_name) %}
            <td class="price">
              {% if ph and ph.price is not none %}
                ${{ "%.2f"|format(ph.price) }}
                {% if ph.discount_percent %}
                  <span class="badge bg-danger pill ms-1">-{{ "%.0f"|format(ph.discount_percent) }}%</span>
                {% endif %}
              {% else %}
                <span class="muted">—</span>
              {% endif %}
            </td>
          {% endfor %}

          <td class="price">
            {% set b = best.get(item.id) %}
            {% if b %}
              <span class="badge bg-success pill">{{ b[0] }}</span>
              ${{ "%.2f"|format(b[1]) }}
            {% else %}
              <span class="muted">—</span>
            {% endif %}
          </td>

          <td class="muted small">
            {% set cyc = cycles.get(item.id) %}
            {% if cyc %}
              {% set chosen = (best.get(item.id) or [None])[0] %}
              {% if chosen and cyc.get(chosen) and cyc.get(chosen).get("next_expected_discount") %}
                Next expected: {{ cyc.get(chosen).get("next_expected_discount").date() }}
              {% else %}
                —
              {% endif %}
            {% else %}
              —
            {% endif %}
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<script>
(function () {
  const formEl = document.getElementById("scrape-form");
  const storeEl = document.getElementById("scrape-store");
  const statusEl = document.getElementById("scrape-status");
  const submitBtnEl = document.getElementById("scrape-submit-btn");

  function setBusy(isBusy) {
    if (!submitBtnEl || !storeEl) return;
    submitBtnEl.disabled = isBusy;
    storeEl.disabled = isBusy;
  }

  function setStatus(text, ok) {
    if (!statusEl) return;
    statusEl.textContent = text || "";
    statusEl.className = ok ? "small text-success" : "small text-danger";
  }

  async function pollJob(jobId) {
    const timer = setInterval(async () => {
      try {
        const res = await fetch(`/scrape/status/${jobId}`);
        const payload = await res.json();
        if (!res.ok || !payload.ok) {
          clearInterval(timer);
          setBusy(false);
          setStatus("Unable to read scrape status.", false);
          return;
        }

        const msg = payload.message ? ` (${payload.message})` : "";
        setStatus(`Scrape: ${payload.status}${msg}`, payload.status !== "error");

        if (payload.status === "done") {
          clearInterval(timer);
          window.location.reload();
        }
        if (payload.status === "error") {
          clearInterval(timer);
          setBusy(false);
        }
      } catch (err) {
        clearInterval(timer);
        setBusy(false);
        setStatus("Scrape status polling failed.", false);
      }
    }, 1500);
  }

  async function startScrape(event) {
    event.preventDefault();
    setBusy(true);
    setStatus("Scrape queued…", true);

    const body = new FormData();
    body.append("store", (storeEl && storeEl.value) || "ALL");

    try {
      const res = await fetch("/scrape/start", { method: "POST", body });
      const payload = await res.json();
      if (!res.ok || !payload.ok || !payload.job_id) {
        throw new Error("Failed to start scrape job");
      }
      pollJob(payload.job_id);
    } catch (err) {
      setBusy(false);
      setStatus("Unable to start scrape job.", false);
    }
  }

  if (formEl) {
    formEl.addEventListener("submit", startScrape);
  }
})();
</script>
{% endblock %}
