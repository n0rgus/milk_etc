<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>{{ title }}</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
    .price { font-variant-numeric: tabular-nums; }
    .muted { color: #6c757d; }
    .pill { font-size: 0.8rem; }
  </style>
</head>
<body class="bg-light">
<nav class="navbar navbar-expand-lg navbar-dark bg-dark">
  <div class="container-fluid">
    <a class="navbar-brand" href="/">{{ title }}</a>
    <div class="navbar-nav align-items-lg-center">
      <a class="nav-link" href="/">Dashboard</a>
      <a class="nav-link" href="/buylist">Buy List</a>
      <a class="nav-link" href="/items/new">Add Item</a>
      <a class="nav-link" href="/capture">Capture Center</a>
      <button class="btn btn-sm btn-outline-light ms-lg-2" type="button" data-bs-toggle="modal" data-bs-target="#scrapeSettingsModal">Settings</button>
    </div>
  </div>
</nav>

<main class="container my-4">
  {% block content %}{% endblock %}
</main>

<div class="modal fade" id="scrapeSettingsModal" tabindex="-1" aria-labelledby="scrapeSettingsModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="scrapeSettingsModalLabel">Scrape Settings</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="scrape-settings-form" class="d-flex flex-column gap-3">
          <div class="form-check">
            <input class="form-check-input" type="checkbox" id="settings-headful">
            <label class="form-check-label" for="settings-headful">Run scraper in headful mode (visible browser)</label>
          </div>

          <div>
            <label class="form-label" for="settings-slowmo">SlowMo (ms)</label>
            <input class="form-control" type="number" min="0" step="50" id="settings-slowmo" value="0">
          </div>

          <div class="form-check">
            <input class="form-check-input" type="checkbox" id="settings-debug-capture">
            <label class="form-check-label" for="settings-debug-capture">Capture debug artifacts on scrape failure (screenshot + HTML)</label>
          </div>

          <div class="form-check">
            <input class="form-check-input" type="checkbox" id="settings-save-storage-state">
            <label class="form-check-label" for="settings-save-storage-state">Persist store session state (storage_state)</label>
          </div>

          <hr class="my-1">

          <div>
            <div class="fw-semibold">Coles Session</div>
            <div class="small text-muted mb-2">Use this when Coles shows an Imperva/hCaptcha security check.</div>

            <label class="form-label" for="coles-init-url">Init URL</label>
            <input class="form-control" type="url" id="coles-init-url" placeholder="https://www.coles.com.au/product/...">

            <label class="form-label mt-2" for="coles-init-slowmo">Init SlowMo (ms)</label>
            <input class="form-control" type="number" min="0" step="50" id="coles-init-slowmo" value="250">

            <button class="btn btn-outline-primary btn-sm mt-3" type="button" id="init-coles-session-btn">Init Coles Session (solve security check)</button>
            <div id="coles-init-feedback" class="small mt-2"></div>
          </div>
        </form>
        <div id="settings-save-feedback" class="small mt-2"></div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" id="save-scrape-settings-btn">Save</button>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
(function () {
  const modalEl = document.getElementById("scrapeSettingsModal");
  const headfulEl = document.getElementById("settings-headful");
  const slowmoEl = document.getElementById("settings-slowmo");
  const debugCaptureEl = document.getElementById("settings-debug-capture");
  const saveStorageStateEl = document.getElementById("settings-save-storage-state");
  const saveBtn = document.getElementById("save-scrape-settings-btn");
  const feedbackEl = document.getElementById("settings-save-feedback");
  const colesInitUrlEl = document.getElementById("coles-init-url");
  const colesInitSlowmoEl = document.getElementById("coles-init-slowmo");
  const initColesBtn = document.getElementById("init-coles-session-btn");
  const colesInitFeedbackEl = document.getElementById("coles-init-feedback");

  function updateSlowmoEnabled() {
    slowmoEl.disabled = !headfulEl.checked;
  }

  function setFeedback(text, ok) {
    feedbackEl.textContent = text || "";
    feedbackEl.className = ok ? "small mt-2 text-success" : "small mt-2 text-danger";
  }

  function setColesFeedback(text, ok) {
    colesInitFeedbackEl.textContent = text || "";
    colesInitFeedbackEl.className = ok ? "small mt-2 text-success" : "small mt-2 text-danger";
  }

  async function loadSettings() {
    setFeedback("", true);
    try {
      const res = await fetch("/api/settings/scrape");
      if (!res.ok) throw new Error("Failed to load settings");
      const data = await res.json();
      headfulEl.checked = !!data.headful;
      slowmoEl.value = Number.isFinite(Number(data.slowmo_ms)) ? Number(data.slowmo_ms) : 0;
      debugCaptureEl.checked = !!data.debug_capture_enabled;
      saveStorageStateEl.checked = !!data.save_storage_state;
      updateSlowmoEnabled();
    } catch (err) {
      setFeedback("Unable to load settings.", false);
    }
  }

  async function saveSettings() {
    setFeedback("", true);
    const payload = {
      headful: !!headfulEl.checked,
      slowmo_ms: Math.max(0, parseInt(slowmoEl.value || "0", 10) || 0),
      debug_capture_enabled: !!debugCaptureEl.checked,
      save_storage_state: !!saveStorageStateEl.checked,
    };

    try {
      const res = await fetch("/api/settings/scrape", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload),
      });
      if (!res.ok) throw new Error("Failed to save settings");
      setFeedback("Saved.", true);
      setTimeout(() => window.location.reload(), 300);
    } catch (err) {
      setFeedback("Unable to save settings.", false);
    }
  }

  async function initColesSession() {
    setColesFeedback("", true);
    const payload = {
      url: (colesInitUrlEl.value || "").trim(),
      slowmo_ms: Math.max(0, parseInt(colesInitSlowmoEl.value || "250", 10) || 250),
    };
    if (!payload.url) {
      setColesFeedback("Please enter a Coles URL first.", false);
      return;
    }

    setColesFeedback("Opening browser for manual verificationâ€¦", true);
    try {
      const res = await fetch("/api/coles/init-session", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload),
      });
      const data = await res.json();
      if (!res.ok || !data.ok) {
        throw new Error(data.message || "Init session failed");
      }
      setColesFeedback(data.message || "Coles init session complete.", true);
    } catch (err) {
      setColesFeedback(err.message || "Unable to initialize Coles session.", false);
    }
  }

  if (modalEl) {
    modalEl.addEventListener("show.bs.modal", loadSettings);
  }
  if (headfulEl) {
    headfulEl.addEventListener("change", updateSlowmoEnabled);
  }
  if (saveBtn) {
    saveBtn.addEventListener("click", saveSettings);
  }
  if (initColesBtn) {
    initColesBtn.addEventListener("click", initColesSession);
  }
})();
</script>
</body>
</html>
